### 				SIMH用户指南，V3.10-0

### 													2018-05-23

## 目录

#### 简介

##### 1. 编译及运行一个模拟器

##### 	1.1 在UNIX/Linux/Mac OS-X下编译

##### 	1.2 在WIndows下编译

##### 		1.2.1 编译时连接有太网

##### 		1.2.2 在MinGW下编译

##### 		1.2.3 在Visual C++下编译

##### 	 1.3 在OpenVMS下编译

##### 2. 模拟器约定

##### 3. 命令

##### 	3.1 加载和保存程序

##### 	3.2 保存和恢复状态

##### 	3.3 重置设备

##### 	3.4 连接和断开设备

##### 	3.5 检查和改变状态

##### 	3.6 对指令求值

##### 	3.7 运行一个模拟程序

##### 		3.7.1 控制模拟速率

##### 	3.8 终止模拟器

##### 		3.8.1 模拟器检测终止状态

##### 		3.8.2 用户指定的终止状态

##### 		3.8.3 断点

##### 	 3.9  设置设备参数

##### 	 3.10 显示参数和状态

##### 	 3.11 改变模拟配置

##### 	 3.12 控制台选项

##### 	 3.13 执行命令文件

##### 		3.13.1 显示任意文本

##### 		3.13.2 测试模拟器状态

##### 	  3.14 执行系统命令

##### 	  3.15 获取帮助

##### 	  3.16 控制调试

##### 	  3.17 退出模拟器

#### 附录1：文件表示

##### 	A.1 硬盘

##### 	A.2 软盘

##### 	 A.3 磁带

##### 	 A.4 行式打印机

##### 	 A.5 DEC磁带

#### 附录2：调试状态

#### 修订历史（包括Rev 2.0到Rev 3.5）

#### 鸣谢



### 2 模拟器约定

​		模拟器由一系列设备构成，首要的设备常常是CPU。设备包括命名寄存器和一个（或多个）编号单元。**寄存器**对应着**设备状态**，**单元**对应着**设备地址空间**。因此，CPU设备可能有像PC，ION等一样的寄存器和一个对应于主存的单元；磁盘设备可能有像 BUSY, DONE等一样的寄存器和对应于单个磁盘驱动的单元。除了主内存，**设备地址空间**被模拟为主机文件系统中的**非结构化的二进制磁盘文件**。 命令SHOW CONFIG显示了模拟器配置。

​		模拟器按照任意单位来计量时间，通常是每执行一条指令一个时间单位。**模拟事件**（如I/O的完成）计划于未来的某些时间单位触发。模拟器**同步执行**，当模拟事件按计划触发时，**调用事件处理器**。即便是像键盘输入一样的异步事件，也是通过**以同步间隔轮询**的方式处理的。命令SHOW QUEUE显示模拟器事件队列。

### 3 命令

模拟器命令包括一个命令动词、可选开关及可选参数。开关采用以下形式：

​		-\<字母\>{\<字母\>...}

多个开关可分开指定或一起指定：-abcd和-a -b -c -d会被同等看待。动词、开关和其他输入（除文件名以外）都是大小写不敏感的。任何以分号（;）打头的命令都被认为是注释，并被忽略。

#### 3.1 加载及保存程序

 命令LOAD（简写LO）以**二进制装载程序格式**加载文件：

​	load \<文件名\> {实现选项 }

 支持的格式类型是特定于实现的。选项（如在某范围内加载）也是特定于实现的。

 命令DUMP(简称DU)以二进制装载程序格式转储内存：

​	dump \<文件名\> {实现选项}

  支持的格式类型是特定于实现的。选项（如某一范围内的转储）也是特定于实现的。

#### 3.2 保存和恢复状态

​		命令SAVE（简写SA）把**模拟器的完整状态**保存到某个文件。这包括**主存的内容**和**所有寄存器**、除网络设备外的**其他设备的I/O连接**（如，以太网控制器和终端多路复用器）： 

​		save \<文件名\>

 		命令RESTORE（简写REST，可供选择的另一个命令是GET）恢复了某个之前保存的模拟器状态：

 		restore \<文件名\>

 		注意：SAVE文件格式压缩了零以最小化文件大小。

#### 3.3 重置设备

​		命令RESET（简写RE）重置某个设备或整个模拟器到某个预定义的条件。

​		若指定了开关-p,则设备被重置到它的加电状态：

​			RESET					 重置所有设备

​			RESET -p				为所有设备接通电源

​			RESET ALL			 重置所有设备

​			RESET\<设备\>	 重置指定设备

 		通常，**RESET**终止**任意进行中的I/O操作**，**清除**任意**中断请求**，并**返回设备**至**休眠状态**。它并不**清除主存**或**影响I/O连接**。

#### 3.4 连接和断开设备

​		除了主存和网络设备，单元被模拟为主机文件系统中的非结构化的二进制磁盘文件。在使用模拟单元前，用户必须指定要被那个单元访问的文件。

​		命令ATTACH（简写AT）把单元和文件联系起来：

​				ATTACH \<单元\> \<文件\>

   如果这个文件不存在，且未指定-e开关，则会创建一个新文件，并打印一个合适的信息。如果指定了-e开关，但未创建一个新文件，则会打印一条错误信息。如果指定了-n开关，则会创建一个新文件或者现存文件的大小缩减至零。

​		如果指定了-r 开关，或该文件被写保护，ATTACH则尝试以只读方式打开文件。如果该文件并不存在，或者该单元并不支持只读操作，则会抛出错误。像纸带阅读器一样的只读设备，和写锁定开关，如磁盘和磁带，支持只读操作；其他设备不支持。若某个文件被附加了只读属性，则可检查其内容，但不可修改。 

​		对于模拟磁带，命令ATTACH可以指定所附接磁带镜像文件的格式: 

​			ATTACH -f    \<磁带单元\> \<格式\> \<文件名\>

​		当前支持的磁带镜像文件格式有：

 			SIMH					SIMH模拟器格式

​			 E11					     E11模拟器格式

​			 TPC							 TPC格式

​			 P7B					皮尔斯模拟器7轨格式

 在使用ATTACH命令前，也可使用SET命令来设置磁带格式。

 SET \<磁带单元\> FORMAT=\<格式\>

​			 ATT \<磁带单元\> \<文件名\>

​		可以用命令SHOW来显示某个附接文件的格式:

​			SHOW \<磁带单元\> FORMAT

​		对于基于Telnet的模拟器，命令ATTACH把主单元和某个TCP/IP端口联系起来:

​			ATTACH \<单元\> \<端口\>

​		该端口是未被标准TCP/IP协议所使用的、位于1和65535之间的一个十进制数。

​		对于以太网模拟器，命令ATTACH把被模拟的以太网和某个物理以太设备联系起来:

​			ATTACH \<单元\> \<物理设备名称\>

 	   命令DETACH（简写DET）把某个单元和文件、端口或网络设备之间的联系断开：

​			DETACH ALL				断开所有单元

​			DETACH \<单元\>		  断开指定单元

​		命令EXIT自动执行了DETACH ALL命令。

 #### 3.5  检查和改变状态

​	有四个命令用于检查和改变状态:

   - **EXAMINE**(缩写:E) 检查状态

   - **DEPOSIT**(缩写:D) 改变状态

   - **IEXAMINE**(交互式检查，缩写:IE) 检查状态，并允许用户交互式地改变它

   - **IDEPOSIT**(交互式存放，缩写:ID)允许用户交互式地改变状态

     所有以上四个命令都表现为如下**形式**：

     ​		命令     {修饰符}     <对象列表>

   **DEPOSIT**必须在命令的末尾包含一个**存放值**。

有四种修饰符：开关(switches),设备/单元名，搜索说明符，输出文件(用于EXAMINE命令)。

前面已经描述过开关。设备/单元标识了将要*被检查(或修改)*<u>地址空间</u>的**设备和单元**。如果没有指定设备，则选择CPU(主存)；如果指定了**设备**，却**没有指定单元**，则选择该设备的**0号单元**。

 **搜索说明符**提供了标准——用于测试**地址**或**寄存器**以查看它们<u>是否应该被处理</u>。说明符由**逻辑操作符**、**地址操作符**或**两者**组成，可以选择用空格分隔。

{<逻辑操作符><值> }  <关系操作符> <值>

此处的**逻辑操作符**是&(与)，|(或)，^(异或)，**关系运算符**是=或==(相等)，!或!=(不相等)，>=(大于等于)，>(大于),<=(小于等于)，<(小于)。若指定了一个**逻辑运算符**，却未指定**关系运算符**，它就会被忽略。若指定了一个关系运算符，却未指定逻辑运算符，则不会执行**逻辑运算**。所有的比较都是无符号的。

**输出文件修饰符**重定向**命令输出**到文件，而**非控制台**。**输出文件修饰符**由**@**加**一个有效的文件名**构成。

可以以**任何顺序指定修饰符**。若指定了同一种类型的多个修饰符，**后指定的修饰符**会覆盖**之前指定的**。注意，若在**搜索说明符**之后出现设备/单元名，则搜索值将被解释为CPU的基数，而非设备或单元的。

**"对象列表"**由以下所列的一个或多个构成，以逗号分隔:

register 						指定的寄存器

register[sub1-sub2]		指定的寄存器数组位置，从位置sub1开始，直到位置sub2(包含sub2)

register[sub1/length]	 指定的寄存器数组位置，从位置sub1开始，直到位置sub1+length(不包含sub1+length)

register[ALL]					指定的寄存器数组中的所有位置

register1-register2 		从register1开始直到register2(包含register2)的所有寄存器

address							指定的位置

address1-address2		从address1开始直到address2(包含address2)的所有位置

address/length			   从address开始直到address+length的所有位置(不包含address+length)

STATE								设备中的所有寄存器

ALL									单元中的所有位置

可以使用开关来控制显示信息的格式:

​		-a								以ASCII格式显示

​		-c								以字符串格式显示

​		-m							  以指定助记符的格式显示

​        -o								以八进制计数法显示

​		-d								以十进制计数法显示

​		-h								以十六进制计数法显示

**模拟器**通常接受**符号输入**(请查看各个模拟器的文档)

示例:

​		ex  1000-1100       		检查1000-1100

​		de  PC  1040		 	 	把程序计数器(PC)设为1040

​		ie    40-50			     	  交互式地检查40:50

​		ie   >1000    40-50   	  交互式地检查子集

​		ex   rx0      50060		 检查50060，RX 单元0

​		ex   rx      sbuf[3-6]		检查RX中SBUF[3]到SUBF[6]

​		de all 0						   把主存设置为零

​		de &77>0   0       			把所有**最低位**为非零的**地址**设置为零

​		ex  -m  @memdump.txt  0-7777		  把内存转储到文件

备注:要终止一个**交互式命令**，只需在要求输入时输入一个无效值(如，XYZ)。

### 3.6 对指令求值

​		EVAL命令对符号指令求值，并返回等价的数值。要获取搜索命令的**数值参数**时，这一命令很有用:

​				EVAL <表达式>

### 3.7 运行一个模拟程序

命令RUN（简写RU）重置所有设备，把它的参数（如果给定了的话）存在PC中，并开始执行。如果没有给定参数，则在当前PC开始执行。

命令GO不重置设备，把它的参数（如果给定了的话）存在PC里，并开始执行。如果没有给定参数，则在当前PC处开始执行。

命令CONT（简写CO）并不重置设备，在当前PC处恢复执行。

 命令STEP（简写S）在当前PC处恢复执行，执行其参数所指定数目的指令。如果没有提供参数，则执行一条指令。

 命令BOOT（简写BO）重置所有设备，并引导参数指定的设备和单元。如果没有给定单元，则会引导单元0。必须附接指定单元。

#### 3.7.1 控制模拟速率

​		默认情况下，模拟器会尽可能快地运行（虽然比正常的优先级低），也会消耗主机系统上所有可用的处理资源。这会增加许多PC的能耗（和操作温度），并耗尽笔记本电脑的电池。

​		命令SET THROTTLE允许用户把有效执行速率减少到某个指定值（指令数/秒），或减少到主机总计算时间的某一指定百分比。

   	 SET THROTTLE xM				把执行速率设置为x mips

​		SET THROTTLE xK			 	把执行速率设置为x kips

​		SET THROTTLE x%			    限制模拟器运行时间为主机时间的x% 

 	 节流只在实现了精确实时延时功能的主机系统上可用。

​	  命令SET NOTHROTTLE关闭了节流。命令SHOW THROTTLE显示了当前的节流设置。

 	 一些模拟器实现了一种不同形式的资源管理，名为**闲置**。不管运行在模拟器上的程序是在空转，还是模拟器全速运转且有任务在运行，闲置都会终止被模拟的执行程序。节流和闲置是互斥的。

### 3.8 终止模拟器

 		直到模拟器检测到错误或终止条件，或直到用户强制终止条件，程序才会停止运行。

#### 3.8.1 模拟器检测终止条件

​		 这些由模拟器检测的终止条件会终止模拟:

​			——HALT指令。如果编码了一个HALT指令，则模拟终止。

​			——断点。该模拟器可能支持断点（请看下文）。

​			——I/O错误。如果在某个I/O操作模拟期间发生了I/O错误，且设置了设备的 stop-on-I/O-error 标志，则模拟通常会停止。

​			——处理器条件。某些处理器条件会终止模拟；这些条件在各个模拟器的具体文档中有描述。

#### 3.8.2 用户指定的终止条件

​			键入中断字符会终止模拟。中断字符由WRU（where are you)控制台选项所定义，且被初始化设置为005(^E)。

#### 3.8.3 断点

​		某个模拟器可能会提供断点功能。某个模拟器可能定义由字母标识的不同类型断点（例如，E代表执行，R代表读取，W代表写入等）。当前大多数模拟器只支持E（执行）断点。

 	   与某个断点相关的是计数（count),可选的还有，一个或多个动作（actions)。每次使用断点时，与之关联的计数（count）都会减少。如果该计数小于等于0，则触发断点；否则，延迟断点。当断点触发时，会自动执行可选的动作。

 		用命令BREAK来设置断点：

​			BREAK {-类型} {\<地址范围\>{[计数]},{地址范围...}}{;动作;动作...}

 		如果没有指定类型，则会使用特定模拟器的默认断点类型（通常是代表执行的E）。如果没有指定地址范围，则会使用当前PC。就像EXAMINE和DEPOSIT，地址范围可能是单个地址，低-高地址范围；或地址/长度的相对范围。示例:

​	BREAK					  					在当前PC处设置E断点

​	BREAK -e 200		 		 			在200处设置E断点

​	BREAK 2000/2[2]						在2000,2001处设置E断点，同时设置count = 2

​	BREAK 100;EX AC;D MQ 0		在100处设置E断点，同时执行动作EX AC和D MQ 0

​	BREAK 100;							     删除位置100处断点上附加的动作

用命令SHOW BREAK来显示当前设置的断点:

​	SHOW {-类型} BREAK {ALL|\<地址范围\>{,\<地址范围\>...}}

​	显示带有指定类型断点的位置。

​	最后，可用命令NOBREAK来清除断点。

### 3.9 设置设备参数

​	 命令SET（简写SE）改变一个或多个设备参数的状态: 

​	 SET \<设备\> \<参数\>{=<值\>},{\<参数\>{=\<值\>},...}

 或一个或多个单元参数:

​	 SET \<单元\> \<参数\>{=\<值\>},{\<参数\>{=\<值\>},...}

大多数参数是特定于模拟器和设备的。例如，磁盘驱动，通常会被设置写允许（WRITEENABLED）或写锁定(LOCKED)； 如果某个磁盘支持多种驱动类型，命令SET可被用于指定驱动类型。所有设备都识别以下参数:

​	OCT								设置数据基数为8

​	DEC					   	     设置数据基数为10

​	HEX					  		  设置数据基数为16

### 3.10 显示参数和状态

​		命令SHOW （简写SH）显示一个或多个设备参数的状态:

​			SHOW {\<修饰符} \<设备\> \<参数\>{=\<值\>},

​					{\<参数\>{=\<值\>},...}

 或一个或多个单元参数:

​			SHOW {\<修饰符} \<单元\> \<参数\>{=\<值\>},

​					{\<参数\>{=\<值\>},...}

​		有**两种修饰符**：**开关**和**输出文件**。前文已描述过开关。输出文件修饰符把命令输出重定向到文件，而非控制台。输出文件修饰符由@后接一个有效的文件名构成。 

​		所有设备都实现了参数**RADIX**（显示基数），**MODIFIERS**（有效修饰符列表），和**NAMES**（逻辑名称）。其他的设备和单元参数是特定于实现的。

​		命令SHOW也被用于显示全局模拟状态:

​			SHOW CONFIGURATION 		显示模拟器配置及所有设备和单元的状态

​			SHOW DEVICES			  		   显示模拟器配置

​			SHOW MODIFIERS					显示所有可用的修饰符

​			SHOW NAMES						   显示所有逻辑名称

​			SHOW QUEUE						   显示模拟器事件队列

​			SHOW TIME							   显示自上次运行起，所经过的时间

​			SHOW VERSION					    显示模拟器版本和选项

​			SHOW \<设备\>							显示指定设备的状态

​			SHOW \<单元\> 							显示指定单元的状态

​		SHOW QUEUE和SHOW TIME显示**特定模拟器**的单元中的时间；通常，一个时间单元代表一条指令执行。

### 3.11 改变模拟配置

​		在大多数模拟器中，命令SET \<设备> DISABLED从配置中移除指定设备。被禁用（DISABLED）的设备对运行中的程序是不可见的。该设备仍可被重置（RESET），但不可被附接（ATTAChed），分离（DETACHed）或引导（BOOTed）。 SET \<设备\> ENABLED恢复某个被禁用设备的配置。

​		大多数多单元设备允许单元被启用或禁用: 

​			SET \<单元\> ENABLED

​			SET \<单元\> DISABLED

​		当某个单元被禁用时，调用命令SHOW DEVICE将不会显示该单元。

​		可用逻辑名称来补充标准设备名称。在某个模拟器内，逻辑名称必须是唯一的。（即，它们不能与现存的设备名称相同）。

​		要把逻辑名称赋给某个设备: 

​			ASSIGN \<设备\> \<逻辑名称\>	把逻辑名称赋给某个设备

​		要移除某个逻辑名称:

​			 DEASSIGN \<设备\>		移除逻辑名称

​		要显示当前逻辑名称赋值:

​			SHOW \<设备\> NAMES	显示逻辑名称（如果有的话）		

 		要显示所有逻辑名称：

​			SHOW NAMES

### 3.12 控制台选项

​		控制台选项是由命令SET CONSOLE 控制的。控制台终端通常运行在控制窗口。可选择把控制台终端连接到某个Telnet端口。这允许系统用Telnet客户端内置的终端模拟器来模拟一个 VT100。

​	SET CONSOLE TELNET=\<port>	把控制台终端连接到Telnet会话的port端口

​	SET CONSOLE NOTELNET		    禁用控制台Telnet

 		到控制台的输出会被同步记录到日志文件:

​			SET CONSOLE LOG=\<文件名\>	  把控制台输出记录到文件

​			SET CONSOLE NOLOG				  禁用日志

 		控制台提供了一个有限的键重映射功能:

​			SET CONSOLE WRU=<value>		  把ASCII代码value解译为WRU

​			SET CONSOLE BRK=<value>			把ASCII代码value解译为BREAK （0禁用）

​			SET CONSOLE DEL=<value>			把ASCII代码value解译为 DELETE

​			SET CONSOLE PCHAR=<value>	   范围[31,0]内可打印字符的位掩码			

​		 在hex CPU上的值是十六进制，其他CPU上的值是八进制。

​		 命令 SHOW CONSOLE 显示了控制台选项的当前状态:

​			SHOW CONSOLE					 显示所有的控制台选项

​			SHOW CONSOLE TELNET	  显示控制台Telnet状态

​			SHOW CONSOLE LOG			显示控制台日志状态

​			SHOW CONSOLE WRU		    显示赋给WRU的值

​			SHOW CONSOLE BRK			 显示赋给BREAK的值

​			SHOW CONSOLE DEL			 显示赋给DELETE的值

​			SHOW CONSOLE PCHAR	    显示赋给PCHAR的值

 		SET CONSOLE和SHOW CONSOLE 两者都接收多个参数，并以逗号分隔它们，如：

​			SET CONSOLE WRU=5,DEL=177	为WRU和DEL设置代码值

### 3.13  执行命令文件

​		模拟器可以调用DO 命令执行命令文件:

​			DO \<文件名\> {参数...}	 执行文件中的命令

 命令DO允许命令文件包含**可替换参数**。字符串%n,此处n位于1到9之间，被来自**DO命令行**的参数n所替代。字符串%0被\<文件名\>所替代。序列\%和\分别被字面量字符%和\所替代。带有空格的参数应被包在匹配的单引号或双引号内。 

​		若指定了开关-v,则在执行文件中的命令前，会回显它们。

​	    如果指定了开关-e, 则在遇到命令错误时，命令处理（包括嵌套的命令调用）将会被终止。（模拟终止从不终止处理；使用ASSERT来捕获意外终止。）不带开关的话，除了ASSERT失败的所有错误将会被忽略，命令处理将会继续。

​		命令DO可能被嵌套至多达10级调用深度。

​		有几个命令在命令文件中特别有用。虽然它们可能被交互式执行，但当它们被这样用时，只有有限的功能。

#### 3.13.1 显示任意文本

​		命令ECHO是一个注释命令文件的有用方式。命令ECHO在控制台打印出其参数:

​			ECHO \<字符串\>			输出字符串到控制台

 		若没有参数，ECHO在控制台打印一个空行。这可被用于在控制台显示或日志里提供行距。

#### 3.13.2 测试模拟器状态

​		命令ASSERT测试一个**模拟器状态条件**，如果**该条件为假**，则**停止命令文件执行**:

​			ASSERT {\<dev\>} \<reg\>{\<logical-op\>\<value\>}\<conditional-op\>\<value\>

 		若未指定\<dev\>,则假定其为CPU。\<reg\>是一个属于指定设备的寄存器（标量或下标）。当\<conditional-op\> 和\<logical-op\> 被命令EXAMINE和DEPOSIT（见上文）用于“搜索说明符”时，它们是等同的。\<value\>是用为\<reg\>所指定的基数表示的，而非用为设备所指定的基数表示。

​		如果指定了\<logical-op\>和\<value\> ,则目标寄存器的值依照首次所指定的方式改变。然后通过\<conditional-op\>将结果与\<value\>相比较。如果该结果为假，则打印 "Assertion failed" 信息，并终止任何运行中的命令文件。否则，该命令无效。

​		例如， 某个命令文件可能被用于引导一个从磁盘初始化加载后就终止的操作系统。然后命令ASSERT被用于确认加载成功完成，这是通过检查CPU的"A"寄存器是否等于预期值实现的:

​			;   OS引导命令文件

​			;

​			ATTACH DS0 os.disk

​			BOOT DS

​			;  A寄存器包含错误码；0=良好的引导

​			ASSERT A=0

​			ATTACH MT0 sys.tape

​			ATTACH MT1 user.tape

​			RUN

 		在此例中，若A寄存器不是零，则会回显 "ASSERT A=0"命令，该命令文件将会被终止，同时显示"Assertion failed" 信息。否则，此命令文件将继续引导该操作系统。



























